<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>FairHire+ — HR Manager</title>
  <link rel="stylesheet" href="hr.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<!-- LOADER -->
<div id="loaderOverlay" class="loader-overlay" style="display:none;"><div class="loader"></div></div>

<!-- CONFIRM -->
<div id="confirmBox" class="confirm-box" style="display:none;">
  <h3 id="confirmTitle">Confirm</h3>
  <p id="confirmText" style="color:#bbb;margin-top:8px;">Are you sure?</p>
  <div class="confirm-buttons">
    <button id="confirmCancel" type="button" class="confirm-btn">Cancel</button>
    <button id="confirmOk" type="button" class="confirm-btn" style="background:#ff4b4b">Yes</button>
  </div>
</div>

<!-- LOGIN VIEW -->
<div id="login-view" class="login-wrapper">
  <form id="loginForm" class="login-box">
    <h2>HR Login</h2>
    <input type="text" name="userid" placeholder="UserID (HR)" required autocomplete="off">
    <input type="password" name="password" placeholder="Password (123)" required autocomplete="off">
    <button class="login-btn" type="submit">Login</button>
    <button id="homeBtn" class="home-btn" type="button">Home</button>
    <div id="loginError" class="error-box" style="display:none;margin-top:10px;">Invalid credentials. Use HR / 123</div>
    <p style="color:#999;margin-top:12px;text-align:center">Use <b>HR</b> / <b>123</b></p>
  </form>
</div>

<!-- APP VIEW -->
<div id="app-view" class="wrapper" style="display:none;">
  <div class="menu-toggle" id="menuToggle">&#9776;</div>
  <div class="sidebar" id="sidebar">
    <div class="brand">FairHire+ — HR</div>
    <a href="#" data-section="dashboard" class="menu-link">Dashboard</a>
    <a href="#" data-section="applicants" class="menu-link">Applicant Overview</a>
    <a href="#" data-section="work_hours" class="menu-link">Work Hours</a>
    <a href="#" data-section="leave_apply" class="menu-link">Leave Apply</a>
    <a href="#" data-section="leaves" class="menu-link">Leave Applications</a>
    <a href="#" data-section="employee_overview" class="menu-link">Employee Overview</a>
    <a href="#" data-section="cm_remarks" class="menu-link">Remarks from Company Manager</a>
    <a href="#" data-section="requests" class="menu-link">Request Overview</a>
    <a href="#" data-section="request-admin" class="menu-link">Request to Admin</a>

    <a id="logoutLink" href="#" style="margin-top:20px;">Logout</a>
  </div>

  <div class="content">
    <div id="content-area">
      <h2 class="empty-note">Select a menu item to load content.</h2>
    </div>
  </div>
</div>

<script>
/* ---------- helpers ---------- */
const loader = {
  show(){ document.getElementById('loaderOverlay').style.display='flex'; },
  hide(){ document.getElementById('loaderOverlay').style.display='none'; }
};

function showConfirm(title, text){
  return new Promise(resolve=>{
    const cb = document.getElementById('confirmBox');
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmText').textContent = text;
    // show modal and ensure it captures pointer events so clicks don't fall-through
    cb.style.display='block';
    cb.style.pointerEvents = 'auto';
    const ok = document.getElementById('confirmOk');
    const cancel = document.getElementById('confirmCancel');
    function cleanup(){ cb.style.display='none'; cb.style.pointerEvents='none'; ok.removeEventListener('click',onOk); cancel.removeEventListener('click',onCancel); }
    function onOk(e){ if (e && e.preventDefault) { e.preventDefault(); e.stopPropagation(); } cleanup(); resolve(true); }
    function onCancel(e){ if (e && e.preventDefault) { e.preventDefault(); e.stopPropagation(); } cleanup(); resolve(false); }
    ok.addEventListener('click', onOk);
    cancel.addEventListener('click', onCancel);
    // focus for keyboard users
    ok.focus();
  });
}

/* ---------- login handling (AJAX) ---------- */
const loginForm = document.getElementById('loginForm');
loginForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  loader.show();
  const fd = new FormData(loginForm);
  fd.append('login','1');
  try {
    const res = await fetch('hr.php', { method:'POST', body:fd, credentials:'same-origin' });
    const text = await res.text();
    try {
      const json = JSON.parse(text);
      if (json.success) {
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('app-view').style.display = 'flex';
        loadSection('dashboard');
      } else {
        document.getElementById('loginError').textContent = json.message || 'Invalid credentials';
        document.getElementById('loginError').style.display = 'block';
      }
    } catch (e) {
      document.getElementById('loginError').style.display = 'block';
    }
  } catch (err) {
    document.getElementById('loginError').style.display = 'block';
    console.error(err);
  } finally {
    loader.hide();
  }
});

/* ---------- home button ---------- */
document.getElementById('homeBtn').addEventListener('click', (e)=>{
  e.preventDefault();
  window.location.href = 'index.html';
});

/* ---------- logout ---------- */
document.getElementById('logoutLink').addEventListener('click', async (e)=>{
  e.preventDefault();
  const ok = await showConfirm('Logout', 'Do you want to logout?');
  if(!ok) return;
  loader.show();
  try {
    await fetch('hr.php?action=logout', { credentials:'same-origin' });
    document.getElementById('app-view').style.display='none';
    document.getElementById('login-view').style.display='flex';
  } catch(e){ console.error(e); }
  loader.hide();
});

/* ---------- sidebar toggle ---------- */
document.getElementById('menuToggle').addEventListener('click', ()=>{
  document.getElementById('sidebar').classList.toggle('active');
});

/* ---------- load section ---------- */
const contentArea = document.getElementById('content-area');

async function loadSection(name){
  loader.show();
  try {
    const res = await fetch('hr.php?section=' + encodeURIComponent(name), { credentials:'same-origin' });
    const html = await res.text();
    contentArea.innerHTML = html;
    bindFragmentEvents();
  } catch(e) {
    contentArea.innerHTML = '<div class="section-card"><p style="color:#ff8b8b">Error loading content.</p></div>';
    console.error(e);
  } finally { loader.hide(); }
}

/* ---------- bind events inside loaded fragments ---------- */
function bindFragmentEvents(){
  document.querySelectorAll('a.api-link').forEach(a=>{
    a.addEventListener('click', async (ev)=>{
      ev.preventDefault();
      const confirmRequired = a.dataset.confirm === 'true';
      if (confirmRequired) {
        const ok = await showConfirm('Confirm action','Are you sure?');
        if (!ok) return;
      }
      loader.show();
      try {
        const res = await fetch(a.href, { credentials:'same-origin' });
        const html = await res.text();
        contentArea.innerHTML = html;
        bindFragmentEvents();
      } catch(e){ console.error(e); }
      loader.hide();
    });
  });

  document.querySelectorAll('form.remark-form').forEach(form=>{
    form.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const ok = await showConfirm('Confirm','Submit this action?');
      if(!ok) return;
      loader.show();
      try {
        const fd = new FormData(form);
        const res = await fetch(form.action, { method:'POST', body:fd, credentials:'same-origin' });
        const html = await res.text();
        contentArea.innerHTML = html;
        bindFragmentEvents();
      } catch(e){ console.error(e); }
      loader.hide();
    });
  });

  document.querySelectorAll('form.request-form').forEach(form=>{
    form.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const ok = await showConfirm('Confirm','Submit this request?');
      if(!ok) return;
      loader.show();
      try {
        const fd = new FormData(form);
        const res = await fetch(form.action, { method:'POST', body:fd, credentials:'same-origin' });
        const html = await res.text();
        contentArea.innerHTML = html;
        bindFragmentEvents();
      } catch(e){ console.error(e); }
      loader.hide();
    });
  });

  document.querySelectorAll('canvas[data-chart]').forEach(canvas=>{
    try {
      const cfg = JSON.parse(canvas.getAttribute('data-chart'));
      const ctx = canvas.getContext('2d');
      new Chart(ctx, cfg);
    } catch(e){ console.error('chart parse', e); }
  });
}

/* ---------- wire menu links ---------- */
document.querySelectorAll('.menu-link').forEach(a=>{
  a.addEventListener('click', (ev)=>{
    ev.preventDefault();
    loadSection(a.dataset.section);
    if (document.getElementById('sidebar').classList.contains('active')) {
      document.getElementById('sidebar').classList.remove('active');
    }
  });
});

/* try check session on load */
(async function(){
  try {
    const res = await fetch('hr.php?check=1', { credentials:'same-origin' });
    const txt = await res.text();
    try {
      const j = JSON.parse(txt);
      if (j.logged) {
        document.getElementById('login-view').style.display='none';
        document.getElementById('app-view').style.display='flex';
        loadSection('dashboard');
      }
    } catch(e){}
  } catch(e){}
})();
</script>
</body>
</html>
