<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>FairHire+ — Employee</title>
  <link rel="stylesheet" href="em.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<!-- LOADER -->
<div id="loaderOverlay" class="loader-overlay" style="display:none;"><div class="loader"></div></div>

<!-- CONFIRM -->
<div id="confirmBox" class="confirm-box" style="display:none;">
  <h3 id="confirmTitle">Confirm</h3>
  <p id="confirmText" style="color:#bbb;margin-top:8px;">Are you sure?</p>
  <div class="confirm-buttons">
    <button id="confirmCancel" class="confirm-btn">Cancel</button>
    <button id="confirmOk" class="confirm-btn" style="background:#4b9eff">Yes</button>
  </div>
</div>

<!-- LOGIN VIEW -->
<div id="login-view" class="login-wrapper">
  <form id="loginForm" class="login-box">
    <h2>Employee Login</h2>
    <input type="text" name="userid" placeholder="UserID (EM)" required autocomplete="off">
    <input type="password" name="password" placeholder="Password (123)" required autocomplete="off">
    <button class="login-btn" type="submit">Login</button>
    <button id="homeBtn" class="home-btn" type="button">Home</button>
    <div id="loginError" class="error-box" style="display:none;margin-top:10px;">Invalid credentials. Use EM / 123</div>
    <p style="color:#999;margin-top:12px;text-align:center">Use <b>EM</b> / <b>123</b></p>
  </form>
</div>

<!-- APP VIEW -->
<div id="app-view" class="wrapper" style="display:none;">
  <div class="menu-toggle" id="menuToggle">&#9776;</div>
  <div class="sidebar" id="sidebar">
    <div class="brand">FairHire+ — Employee</div>
    <a href="#" data-section="dashboard" class="menu-link">Dashboard</a>
    <a href="#" data-section="work_hours" class="menu-link">Work Hours</a>
    <a href="#" data-section="compensation_summary" class="menu-link">Compensation Summary</a>
    <a href="#" data-section="leave_apply" class="menu-link">Leave Apply</a>
    <a href="#" data-section="requests" class="menu-link">Requests</a>

    <a id="logoutLink" href="#" style="margin-top:20px;">Logout</a>
  </div>

  <div class="content">
    <div id="content-area">
      <h2 class="empty-note">Select a menu item to load content.</h2>
    </div>
  </div>
</div>

<script>
/* ---------- helpers ---------- */
const loader = {
  show(){ document.getElementById('loaderOverlay').style.display='flex'; },
  hide(){ document.getElementById('loaderOverlay').style.display='none'; }
};

function showConfirm(title, text){
  return new Promise(resolve=>{
    const cb = document.getElementById('confirmBox');
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmText').textContent = text;
    cb.style.display='block';
    const ok = document.getElementById('confirmOk');
    const cancel = document.getElementById('confirmCancel');
    function cleanup(){ cb.style.display='none'; ok.removeEventListener('click',onOk); cancel.removeEventListener('click',onCancel); }
    function onOk(){ cleanup(); resolve(true); }
    function onCancel(){ cleanup(); resolve(false); }
    ok.addEventListener('click', onOk);
    cancel.addEventListener('click', onCancel);
  });
}

/* ---------- login handling (AJAX) ---------- */
const loginForm = document.getElementById('loginForm');
loginForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  loader.show();
  const fd = new FormData(loginForm);
  fd.append('login','1');
  try {
    const res = await fetch('em.php', { method:'POST', body:fd, credentials:'same-origin' });
    const text = await res.text();
    try {
      const json = JSON.parse(text);
      if (json.success) {
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('app-view').style.display = 'flex';
        loadSection('dashboard');
      } else {
        document.getElementById('loginError').textContent = json.message || 'Invalid credentials';
        document.getElementById('loginError').style.display = 'block';
      }
    } catch (e) {
      document.getElementById('loginError').style.display = 'block';
    }
  } catch (err) {
    document.getElementById('loginError').style.display = 'block';
    console.error(err);
  } finally {
    loader.hide();
  }
});

/* ---------- home button ---------- */
document.getElementById('homeBtn').addEventListener('click', (e)=>{
  e.preventDefault();
  window.location.href = 'index.html';
});

/* ---------- logout ---------- */
document.getElementById('logoutLink').addEventListener('click', async (e)=>{
  e.preventDefault();
  const ok = await showConfirm('Logout', 'Do you want to logout?');
  if(!ok) return;
  loader.show();
  try {
    await fetch('em.php?action=logout', { credentials:'same-origin' });
    document.getElementById('app-view').style.display='none';
    document.getElementById('login-view').style.display='flex';
  } catch(e){ console.error(e); }
  loader.hide();
});

/* ---------- sidebar toggle ---------- */
document.getElementById('menuToggle').addEventListener('click', ()=>{
  document.getElementById('sidebar').classList.toggle('active');
});

/* ---------- load section ---------- */
const contentArea = document.getElementById('content-area');

async function loadSection(name){
  loader.show();
  try {
    const res = await fetch('em.php?section=' + encodeURIComponent(name), { credentials:'same-origin' });
    const html = await res.text();
    contentArea.innerHTML = html;
    bindFragmentEvents();
  } catch(e) {
    contentArea.innerHTML = '<div class="section-card"><p style="color:#ff8b8b">Error loading content.</p></div>';
    console.error(e);
  } finally { loader.hide(); }
}

/* ---------- bind events inside loaded fragments ---------- */
function bindFragmentEvents(){
  document.querySelectorAll('form.request-form').forEach(form=>{
    form.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const ok = await showConfirm('Confirm','Submit this request?');
      if(!ok) return;
      loader.show();
      try {
        const fd = new FormData(form);
        const res = await fetch('em.php', { method:'POST', body:fd, credentials:'same-origin' });
        const html = await res.text();
        contentArea.innerHTML = html;
        bindFragmentEvents();
      } catch(e){ console.error(e); }
      loader.hide();
    });
  });

  // Live compute Hours Worked for the Add/Update Work Hours form
  document.querySelectorAll('form.request-form').forEach(form=>{
    // identify work_hours form by hidden action field
    const actionInput = form.querySelector('input[name="action"][value="add_work_hours"]');
    if (!actionInput) return;

    const startInput = form.querySelector('input[name="start_time"]');
    const endInput = form.querySelector('input[name="end_time"]');
    const dateInput = form.querySelector('input[name="work_date"]');
    let hoursDisplay = form.querySelector('#todayHoursInput');

    // if the server didn't render the input (should now always be present), create a display
    if (!hoursDisplay) {
      const div = document.createElement('div');
      div.className = 'form-group';
      div.innerHTML = '<label>Hours Worked (Today)</label><input id="todayHoursInput" type="text" disabled style="background:#0a0a0a;color:#4b9eff;font-weight:600;">';
      const submitBtn = form.querySelector('button[type="submit"]');
      if (submitBtn && submitBtn.parentNode) submitBtn.parentNode.insertBefore(div, submitBtn);
      hoursDisplay = form.querySelector('#todayHoursInput');
    }

    function computeHours(){
      const startVal = startInput && startInput.value ? startInput.value : null;
      const endVal = endInput && endInput.value ? endInput.value : null;
      const dateVal = dateInput && dateInput.value ? dateInput.value : (new Date()).toISOString().slice(0,10);
      if (!startVal || !endVal) {
        hoursDisplay.value = '0.00 hours';
        return;
      }
      try {
        // build ISO datetime strings
        const s = new Date(dateVal + 'T' + (startVal.length===5? startVal+':00' : startVal));
        const e = new Date(dateVal + 'T' + (endVal.length===5? endVal+':00' : endVal));
        let diff = (e.getTime() - s.getTime()) / 1000; // seconds
        if (isNaN(diff) || diff < 0) diff = 0;
        const hrs = (diff / 3600);
        hoursDisplay.value = hrs.toFixed(2) + ' hours';
      } catch(err){
        hoursDisplay.value = '0.00 hours';
      }
    }

    // attach listeners
    if (startInput) startInput.addEventListener('change', computeHours);
    if (endInput) endInput.addEventListener('change', computeHours);
    if (dateInput) dateInput.addEventListener('change', computeHours);
    // initialize
    computeHours();
  });

  document.querySelectorAll('canvas[data-chart]').forEach(canvas=>{
    try {
      const cfg = JSON.parse(canvas.getAttribute('data-chart'));
      const ctx = canvas.getContext('2d');
      new Chart(ctx, cfg);
    } catch(e){ console.error('chart parse', e); }
  });
}

/* ---------- wire menu links ---------- */
document.querySelectorAll('.menu-link').forEach(a=>{
  a.addEventListener('click', (ev)=>{
    ev.preventDefault();
    loadSection(a.dataset.section);
    if (document.getElementById('sidebar').classList.contains('active')) {
      document.getElementById('sidebar').classList.remove('active');
    }
  });
});

/* try check session on load */
(async function(){
  try {
    const res = await fetch('em.php?check=1', { credentials:'same-origin' });
    const txt = await res.text();
    try {
      const j = JSON.parse(txt);
      if (j.logged) {
        document.getElementById('login-view').style.display='none';
        document.getElementById('app-view').style.display='flex';
        loadSection('dashboard');
      }
    } catch(e){}
  } catch(e){}
})();
</script>
</body>
</html>
