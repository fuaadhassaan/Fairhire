<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>FairHire+ — Admin</title>
  <link rel="stylesheet" href="admin.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>

<div id="loaderOverlay" class="loader-overlay" style="display:none;"><div class="loader"></div></div>

<div id="confirmBox" class="confirm-box" style="display:none;">
  <h3 id="confirmTitle">Confirm</h3>
  <p id="confirmText" style="color:#bbb;margin-top:8px;">Are you sure?</p>
  <div class="confirm-buttons">
    <button id="confirmCancel" type="button" class="confirm-btn">Cancel</button>
    <button id="confirmOk" type="button" class="confirm-btn" style="background:#ff6b6b">Yes</button>
  </div>
</div>

<div id="login-view" class="login-wrapper">
  <form id="loginForm" class="login-box">
    <h2>Admin Login</h2>
    <input type="text" name="userid" placeholder="UserID (AD)" required autocomplete="off">
    <input type="password" name="password" placeholder="Password (123)" required autocomplete="off">
    <button class="login-btn" type="submit">Login</button>
    <button id="homeBtn" class="home-btn" type="button">Home</button>
    <div id="loginError" class="error-box" style="display:none;margin-top:10px;">Invalid credentials. Use AD / 123</div>
    <p style="color:#999;margin-top:12px;text-align:center">Use <b>AD</b> / <b>123</b></p>
  </form>
</div>

<div id="app-view" class="wrapper" style="display:none;">
  <div class="menu-toggle" id="menuToggle">&#9776;</div>
  <div class="sidebar" id="sidebar">
    <div class="brand">FairHire+ — Admin</div>
    <a href="#" data-section="dashboard" class="menu-link">Dashboard</a>
    <a href="#" data-section="applicants" class="menu-link">Applicant Overview</a>
    <a href="#" data-section="work_hours" class="menu-link">Work Hours</a>
    <a href="#" data-section="employee_overview" class="menu-link">Employee Overview</a>
    <a href="#" data-section="cm_remarks" class="menu-link">Remarks from Company Manager</a>
    <a href="#" data-section="leaves" class="menu-link">Leave Applications</a>
    <a href="#" data-section="requests" class="menu-link">Request Overview</a>

    <a id="logoutLink" href="#" style="margin-top:20px;">Logout</a>
  </div>

  <div class="content">
    <div id="content-area">
      <h2 class="empty-note">Select a menu item to load content.</h2>
    </div>
  </div>
</div>

<script>
/* ---------- helpers ---------- */
const loader = {
  show(){ document.getElementById('loaderOverlay').style.display='flex'; },
  hide(){ document.getElementById('loaderOverlay').style.display='none'; }
};

function showConfirm(title, text){
  return new Promise(resolve=>{
    const cb = document.getElementById('confirmBox');
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmText').textContent = text;
    cb.style.display='block';
    cb.style.pointerEvents = 'auto';
    const ok = document.getElementById('confirmOk');
    const cancel = document.getElementById('confirmCancel');
    function cleanup(){ cb.style.display='none'; cb.style.pointerEvents='none'; ok.removeEventListener('click',onOk); cancel.removeEventListener('click',onCancel); }
    function onOk(e){ if (e && e.preventDefault) { e.preventDefault(); e.stopPropagation(); } cleanup(); resolve(true); }
    function onCancel(e){ if (e && e.preventDefault) { e.preventDefault(); e.stopPropagation(); } cleanup(); resolve(false); }
    ok.addEventListener('click', onOk);
    cancel.addEventListener('click', onCancel);
    ok.focus();
  });
}

/* ---------- ACTION HANDLERS (GLOBAL) ---------- */

// 1. PDF Download
function downloadPDF(elementId, filename) {
    const element = document.getElementById(elementId);
    if (!element) { alert('Content to print not found'); return; }
    
    // Clone to remove buttons for the PDF
    const clone = element.cloneNode(true);
    const buttons = clone.querySelectorAll('button, .action-btn, form');
    buttons.forEach(b => b.style.display = 'none'); // Hide buttons in PDF

    const opt = {
        margin: 5,
        filename: filename + ".pdf",
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: "mm", format: "a4", orientation: "landscape" }
    };
    html2pdf().set(opt).from(clone).save();
}

// 2. Handle Deletion / Simple Actions
async function deleteEntry(action, id) {
    const ok = await showConfirm('Confirm Action', 'Are you sure you want to proceed? This cannot be undone.');
    if(!ok) return;

    loader.show();
    const fd = new FormData();
    fd.append('action', action);
    fd.append('id', id);

    try {
        const res = await fetch('admin.php', { method: 'POST', body: fd });
        const data = await res.json();
        if(data.success) {
            refreshCurrentSection();
        } else {
            alert("Error: " + (data.message || "Operation failed"));
        }
    } catch(e) {
        console.error(e);
        alert("Request failed.");
    } finally {
        loader.hide();
    }
}

// 3. Handle Edit Forms
async function submitEditForm(event) {
    event.preventDefault();
    const ok = await showConfirm('Save Changes', 'Do you want to save these changes?');
    if(!ok) return;

    loader.show();
    const form = event.target;
    const fd = new FormData(form);
    
    // Extract action from URL in form attribute
    const url = new URL(form.action, window.location.href);
    const action = url.searchParams.get('action');
    fd.append('action', action);

    try {
        const res = await fetch('admin.php', { method: 'POST', body: fd });
        const data = await res.json();
        if(data.success) {
            refreshCurrentSection();
        } else {
            alert("Error: " + (data.message || "Save failed"));
        }
    } catch(e) {
        console.error(e);
    } finally {
        loader.hide();
    }
}

function refreshCurrentSection() {
    const active = document.querySelector('.menu-link.active');
    if(active) {
        loadSection(active.dataset.section);
    } else {
        loadSection('dashboard');
    }
}

/* ---------- Login Logic ---------- */
const loginForm = document.getElementById('loginForm');
loginForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  loader.show();
  const fd = new FormData(loginForm);
  fd.append('login','1');
  try {
    const res = await fetch('admin.php', { method:'POST', body:fd });
    const json = await res.json();
    if (json.success) {
      document.getElementById('login-view').style.display = 'none';
      document.getElementById('app-view').style.display = 'flex';
      loadSection('dashboard');
    } else {
      document.getElementById('loginError').textContent = json.message || 'Invalid credentials';
      document.getElementById('loginError').style.display = 'block';
    }
  } catch (err) {
    document.getElementById('loginError').style.display = 'block';
  } finally {
    loader.hide();
  }
});

/* ---------- Navigation ---------- */
document.getElementById('homeBtn').addEventListener('click', (e)=>{ e.preventDefault(); window.location.href = 'index.html'; });

document.getElementById('logoutLink').addEventListener('click', async (e)=>{
  e.preventDefault();
  const ok = await showConfirm('Logout', 'Do you want to logout?');
  if(!ok) return;
  loader.show();
  await fetch('admin.php?action=logout');
  document.getElementById('app-view').style.display='none';
  document.getElementById('login-view').style.display='flex';
  loader.hide();
});

document.getElementById('menuToggle').addEventListener('click', ()=>{
  document.getElementById('sidebar').classList.toggle('active');
});

const contentArea = document.getElementById('content-area');

async function loadSection(name){
  loader.show();
  // Set active class
  document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
  const link = document.querySelector(`.menu-link[data-section="${name}"]`);
  if(link) link.classList.add('active');

  try {
    const res = await fetch('admin.php?section=' + encodeURIComponent(name));
    const html = await res.text();
    contentArea.innerHTML = html;
    bindFragmentEvents();
  } catch(e) {
    contentArea.innerHTML = '<div class="section-card"><p style="color:#ff8b8b">Error loading content.</p></div>';
  } finally { loader.hide(); }
}

function bindFragmentEvents(){
  // Only need to bind Charts now, as clicks are handled by global functions
  document.querySelectorAll('canvas[data-chart]').forEach(canvas=>{
    try {
      const cfg = JSON.parse(canvas.getAttribute('data-chart'));
      new Chart(canvas.getContext('2d'), cfg);
    } catch(e){}
  });
}

document.querySelectorAll('.menu-link').forEach(a=>{
  a.addEventListener('click', (ev)=>{
    ev.preventDefault();
    loadSection(a.dataset.section);
    if (document.getElementById('sidebar').classList.contains('active')) {
      document.getElementById('sidebar').classList.remove('active');
    }
  });
});

/* Check Session */
(async function(){
  try {
    const res = await fetch('admin.php?check=1');
    const j = await res.json();
    if (j.logged) {
      document.getElementById('login-view').style.display='none';
      document.getElementById('app-view').style.display='flex';
      loadSection('dashboard');
    }
  } catch(e){}
})();
// 4. Toggle Select All
function toggleAll(source) {
    const checkboxes = document.querySelectorAll('.row-select');
    checkboxes.forEach(cb => cb.checked = source.checked);
}

// 5. Handle Bulk Delete
async function bulkDelete(tableType) {
    // Gather selected IDs
    const checkedBoxes = document.querySelectorAll('.row-select:checked');
    if (checkedBoxes.length === 0) {
        alert("Please select at least one item.");
        return;
    }

    const ids = Array.from(checkedBoxes).map(cb => cb.value).join(',');
    
    const ok = await showConfirm('Bulk Delete', `Are you sure you want to delete ${checkedBoxes.length} items?`);
    if(!ok) return;

    loader.show();
    const fd = new FormData();
    fd.append('action', 'bulk_delete');
    fd.append('type', tableType);
    fd.append('ids', ids);

    try {
        const res = await fetch('admin.php', { method: 'POST', body: fd });
        const data = await res.json();
        if(data.success) {
            refreshCurrentSection(); // Reloads the table
        } else {
            alert("Error: " + (data.message || "Operation failed"));
        }
    } catch(e) {
        console.error(e);
        alert("Request failed.");
    } finally {
        loader.hide();
    }
}
</script>
</body>
</html>